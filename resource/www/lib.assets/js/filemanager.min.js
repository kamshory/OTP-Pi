var tree=[],source="";function expandDir(e){$(".dir").find('li[data-path="'+e+'"]').addClass("expanded")}function openDir(e){for(var t=e.split("/");t.length>0;)expandDir(t.join("/")),t.pop()}function getParentDir(e){var t=e.split("/");return t.pop(),t.join("/")}function renderFile(e,t){if(void 0!==e){$(".file-container table tbody").empty();var a=1;a=renderRowFile(e,t,a=renderRowDir(e,t,a=renderRowParentDir(e,t,a)))}}function renderRowParentDir(e,t,a){var r;return""!=t&&((r=$('<tr><td><input type="checkbox" disabled></td><td><span class="icon icon-dir"></span></td><td><a href="javascript:;"><span class="updir">&larrhk;</span></a></td><td></td><td class="file-modify"></td><td>[DIR]</td></tr>')).addClass("dir-item"),r.attr("data-path",getParentDir(t)),$(".file-container table tbody").append(r),a++),a}function renderRowDir(e,t,a){var r,i,n,d,l;for(i in e)n=""!=t?t+"/"+e[i].name:e[i].name,"dir"==e[i].type&&((r=new Date).setTime(e[i].modified),d=(d=(d=r.toISOString()).substring(0,19)).replace("T"," "),(l=$('<tr><td><input type="checkbox" class="check-all" name="id[]" value="'+n+'"></td><td><span class="icon icon-dir"></span></td><td><a href="javascript:;">'+e[i].name+'</a></td><td></td><td class="file-modify">'+d+"</td><td>[DIR]</td></tr>")).addClass("dir-item"),l.attr("data-path",n),$(".file-container table tbody").append(l),a++);return a}function renderRowFile(e,t,a){var r,i,n,d,l;for(i in e)if(n=""!=t?t+"/"+e[i].name:e[i].name,"file"==e[i].type){(r=new Date).setTime(e[i].modified),d=(d=(d=r.toISOString()).substring(0,19)).replace("T"," ");var o=Math.ceil(e[i].size/1024),c=getParentDir(source)+"/download/"+n;(l=$('<tr><td><input type="checkbox" class="check-all" name="id[]" value="'+n+'"></td><td><span class="icon icon-file"></span></td><td><a href="'+c+'">'+e[i].name+'</a></td><td align="right">'+o+'</td><td class="file-modify">'+d+"</td><td>[FILE]</td></tr>")).addClass("file-item"),l.attr("data-path",n),$(".file-container table tbody").append(l),a++}return a}function listFile(e){var t=e.split("/"),a=[],r=JSON.parse(JSON.stringify(tree));for(var i in t)""!=t[i]&&(null!=(r=getChildByName(r,t[i]))&&(a=r),console.log(r));return a}function getChildByName(e,t){if(void 0===e)return null;for(var a in e)if(e[a].name==t)return e[a].child}function hashSubdir(e){var t=e.child;for(var a in t)if("dir"==t[a].type)return!0;return!1}function renderDirrectory(e,t){var a="",r="";for(var i in e)if("dir"==e[i].type){r=""!=t?t+"/"+e[i].name:e[i].name,a+=hashSubdir(e[i])?'<li data-name="'+e[i].name+'" data-path="'+r+'" class="icon icon-dir"><a href="javascript:;">'+e[i].name+"</a><ul>"+renderDirrectory(e[i].child,r)+"</ul></li>":'<li data-name="'+e[i].name+'" data-path="'+r+'" class="icon icon-dir"><a href="javascript:;">'+e[i].name+"</a></li>"}return a}$(document).ready(function(e){source=$(".file-manager").attr("data-source"),$.ajax({type:"GET",url:source,dataType:"json",success:function(e){renderFile(tree=e,""),$(".parentdir").append(renderDirrectory(tree,"")),$(".select-path").empty(),$(".select-path").append('<option value=""></option>'),$(".parentdir").find("li").each(function(e){var t=$(this).attr("data-path"),a=$("<option />");a.append(t),a.attr("value",t),$(".select-path").append(a)})}}),$(document).on("click",".dir a",function(e){var t=$(this).closest("li");t.hasClass("expanded")?t.removeClass("expanded"):t.addClass("expanded");var a=t.attr("data-path");$(".select-path").val(a),renderFile(listFile(a),a)}),$(document).on("click",".file-container table tbody .dir-item a",function(e){var t=$(this).closest("tr").attr("data-path");$(".select-path").val(t),""==t?renderFile(tree,""):(expandDir(t),renderFile(listFile(t),t))}),$(document).on("change",".select-path",function(e){var t=$(this).val();""==t?renderFile(tree,""):(expandDir(t),openDir(t),renderFile(listFile(t),t))})});