var tree=[],source="";function repeatText(c,d){for(var a="",b=1;b<c;b++)a+=d;return a}function expandDir(a){$(".dir").find('li[data-path="'+a+'"]').addClass("expanded")}function openDir(b){for(var a=b.split("/");a.length>0;)expandDir(a.join("/")),a.pop()}function getParentDir(b){var a=b.split("/");return a.pop(),a.join("/")}function renderFile(b,c){if(void 0!==b){$(".file-container table tbody").empty();var a=1;a=renderRowParentDir(b,c,a),a=renderRowDir(b,c,a),a=renderRowFile(b,c,a)}}function renderRowParentDir(d,b,c){var a;return""!=b&&((a=$('<tr><td><input type="checkbox" disabled></td><td><span class="icon icon-dir"></span></td><td><a href="javascript:;"><span class="updir">&larrhk;</span></a></td><td></td><td class="file-modify"></td><td>[DIR]</td></tr>')).addClass("dir-item"),a.attr("data-path",getParentDir(b)),$(".file-container table tbody").append(a),c++),c}function renderRowDir(a,f,g){var h,b,d,c,e;for(b in a)d=""!=f?f+"/"+a[b].name:a[b].name,"dir"==a[b].type&&((h=new Date).setTime(a[b].modified),c=(c=(c=h.toISOString()).substring(0,19)).replace("T"," "),(e=$('<tr><td><input type="checkbox" class="check-all" name="id[]" value="'+d+'"></td><td><span class="icon icon-dir"></span></td><td><a href="javascript:;">'+a[b].name+'</a></td><td></td><td class="file-modify">'+c+"</td><td>[DIR]</td></tr>")).addClass("dir-item"),e.attr("data-path",d),$(".file-container table tbody").append(e),g++);return g}function renderRowFile(a,d,e){for(f in a)if(b=""!=d?d+"/"+a[f].name:a[f].name,"file"==a[f].type){(j=new Date).setTime(a[f].modified),g=(g=(g=j.toISOString()).substring(0,19)).replace("T"," ");var j,f,b,g,c,h=Math.ceil(a[f].size/1024),i=getParentDir(source)+"/download/"+b;(c=$('<tr><td><input type="checkbox" class="check-all" name="id[]" value="'+b+'"></td><td><span class="icon icon-file"></span></td><td><a href="'+i+'">'+a[f].name+'</a></td><td align="right">'+h+'</td><td class="file-modify">'+g+"</td><td>[FILE]</td></tr>")).addClass("file-item"),c.attr("data-path",b),$(".file-container table tbody").append(c),e++}return e}function listFile(e){var b=e.split("/"),c=[],a=JSON.parse(JSON.stringify(tree));for(var d in b)""!=b[d]&&(null!=(a=getChildByName(a,b[d]))&&(c=a),console.log(a));return c}function getChildByName(a,c){if(void 0===a)return null;for(var b in a)if(a[b].name==c)return a[b].child}function hashSubdir(b){var a=b.child;for(var c in a)if("dir"==a[c].type)return!0;return!1}function renderDirrectory(a,e,c){c=c||1;var f="",d="";for(var b in a)if("dir"==a[b].type){var g="";d=""!=e?e+"/"+a[b].name:a[b].name,g=hashSubdir(a[b])?'<li data-level="'+c+'" data-name="'+a[b].name+'" data-path="'+d+'" class="icon icon-dir"><a href="javascript:;">'+a[b].name+"</a><ul>"+renderDirrectory(a[b].child,d,c+1)+"</ul></li>":'<li data-level="'+c+'" data-name="'+a[b].name+'" data-path="'+d+'" class="icon icon-dir"><a href="javascript:;">'+a[b].name+"</a></li>",f+=g}return f}$(document).ready(function(a){source=$(".file-manager").attr("data-source"),$.ajax({type:"GET",url:source,dataType:"json",success:function(a){renderFile(tree=a,""),$(".parentdir").append(renderDirrectory(tree,"")),$(".select-path").empty(),$(".select-path").append('<option value=""></option>'),$(".parentdir").find("li").each(function(c){var b=$(this).attr("data-path"),a=$("<option />");a.append(b),a.attr("value",b),$(".select-path").append(a)})}}),$(document).on("click",".dir a",function(c){var a=$(this).closest("li");a.hasClass("expanded")?a.removeClass("expanded"):a.addClass("expanded");var b=a.attr("data-path");$(".select-path").val(b),renderFile(listFile(b),b)}),$(document).on("click",".file-container table tbody .dir-item a",function(b){var a=$(this).closest("tr").attr("data-path");$(".select-path").val(a),""==a?renderFile(tree,""):(expandDir(a),renderFile(listFile(a),a))}),$(document).on("change",".select-path",function(b){var a=$(this).val();""==a?renderFile(tree,""):(expandDir(a),openDir(a),renderFile(listFile(a),a))})})